<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Authentication System Integration</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/1-3-authentication-system-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to sign up and log in with email/password using Better-Auth</iWant>
    <soThat>I can securely access the application</soThat>
    <tasks>
- Task 1: Verify Better-Auth configuration and environment setup (AC: #1, #2, #3, #5)
  - Review Better-Auth config in packages/auth/src/index.ts
  - Verify environment variables are loaded correctly (BETTER_AUTH_SECRET, BETTER_AUTH_URL)
  - Confirm email/password plugin is enabled
  - Verify nextCookies plugin configuration
  - Check cookie security flags in Better-Auth config
  - Test: Start dev server and verify no auth configuration errors

- Task 2: Test sign-up flow end-to-end (AC: #1)
  - Navigate to /login page
  - Switch to sign-up form
  - Enter test data: unique email, name, password (min 8 chars)
  - Submit form and verify redirect to /dashboard
  - Verify success toast appears
  - Check database: user record created with hashed password
  - Check database: account record created with providerId="credential"
  - Verify session created in sessions table

- Task 3: Test login flow with valid credentials (AC: #2)
  - Use seed data test user: test@example.com / TestPassword123!
  - Navigate to /login page (sign-in form)
  - Enter valid credentials
  - Submit and verify redirect to /dashboard
  - Verify user name appears in dashboard ("Welcome {name}")
  - Verify user menu shows correct email
  - Check database: new session created

- Task 4: Test invalid credentials error handling (AC: #3)
  - Attempt login with wrong password
  - Verify error toast appears with clear message
  - Verify no redirect occurs (stay on /login)
  - Verify no session created in database
  - Test with non-existent email
  - Test with empty fields (should be blocked by validation)

- Task 5: Test session persistence across browser refresh (AC: #4)
  - Log in with valid credentials
  - Verify on /dashboard
  - Refresh browser (F5)
  - Verify still logged in on /dashboard
  - Verify user data still displayed
  - Check session cookie still present in browser DevTools

- Task 6: Verify session cookie security flags (AC: #5)
  - Log in and open browser DevTools → Application → Cookies
  - Locate Better-Auth session cookie
  - Verify httpOnly flag is checked
  - Verify sameSite attribute is "Lax"
  - Note: secure flag only applies in production (HTTPS)
  - Verify cookie expiration time is reasonable (7 days default)

- Task 7: Test logout flow (AC: #6)
  - Log in and navigate to /dashboard
  - Click user menu dropdown
  - Click "Sign Out" button
  - Verify redirect to home page (/)
  - Check database: session should be deleted or invalidated
  - Verify session cookie removed from browser
  - Attempt to access /dashboard - should redirect to /login

- Task 8: Test protected route redirection (AC: #7)
  - Ensure logged out (clear cookies if needed)
  - Directly navigate to /dashboard in browser
  - Verify automatic redirect to /login
  - Log in successfully
  - Verify redirect back to /dashboard works

- Task 9: Verify form validation UX (AC: #8)
  - Test email validation: invalid format shows error
  - Test password validation: <8 chars shows error
  - Test name validation (sign-up): <2 chars shows error
  - Verify errors display in red color
  - Verify submit button disabled when form invalid
  - Verify inline errors appear on blur
  - Verify errors clear when field becomes valid

- Task 10: Polish and edge case testing (AC: All)
  - Test rapid form submissions (should prevent double-submit)
  - Test network error handling (disconnect network during submit)
  - Verify loading states during authentication
  - Test email case sensitivity (should be case-insensitive)
  - Verify password is properly obscured in password field
  - Test with different browsers (Chrome, Firefox, Safari)

- Task 11: Document authentication flow (AC: All)
  - Document available test users from seed data
  - Document environment variables required
  - Add comments to auth configuration explaining security settings
  - Update README with authentication testing instructions
    </tasks>
  </story>

  <acceptanceCriteria>
1. User sign-up flow works end-to-end
   - Given I am on the login page
   - When I enter valid email, name, and password (min 8 characters)
   - Then I am automatically logged in and redirected to /dashboard
   - And I see a success toast notification
   - And my user record is created in the database with proper password hash

2. User login flow works with valid credentials
   - Given I am a registered user
   - When I enter my correct email and password on the login page
   - Then I am logged in and redirected to /dashboard
   - And I see my name displayed in the user menu
   - And my session is stored in database

3. Invalid credentials show clear error messages
   - Given I attempt to log in with incorrect credentials
   - When I submit the form
   - Then I see an error toast with clear message
   - And I remain on the login page
   - And no session is created

4. Session persists across browser refresh
   - Given I am logged in
   - When I refresh the browser
   - Then I remain logged in on the /dashboard page
   - And my session data is still accessible

5. Session cookies have proper security flags
   - Given I log in successfully
   - Then the session cookie has httpOnly flag set
   - And the cookie has secure flag set (in production)
   - And the cookie has sameSite=lax flag set
   - And the cookie expiration is properly configured

6. Logout clears session and redirects
   - Given I am logged in on /dashboard
   - When I click "Sign Out" in the user menu
   - Then my session is destroyed in the database
   - And I am redirected to the home page (/)
   - And I cannot access /dashboard without logging in again

7. Protected routes redirect unauthenticated users
   - Given I am not logged in
   - When I attempt to access /dashboard directly
   - Then I am redirected to /login page
   - And I see the login form

8. Form validation provides inline feedback
   - Given I am on the sign-up or sign-in form
   - When I enter invalid data (short password, invalid email)
   - Then I see inline validation errors in red
   - And the submit button is disabled until valid
   - And error messages are clear and actionable
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Authentication Flow</section>
        <snippet>Better-Auth provides session management. Sessions stored in PostgreSQL via Drizzle adapter. ORPC context receives session from Better-Auth middleware. Session validation on every request via nextCookies plugin.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Security Architecture</section>
        <snippet>Session cookies: httpOnly (XSS protection), sameSite=lax (CSRF protection), secure (HTTPS only). Session expiration: 7 days default. Password hashing: scrypt algorithm via Better-Auth.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Integration Points</section>
        <snippet>Better-Auth handles authentication endpoints natively at /api/auth/* routes. Frontend uses Better-Auth React client (authClient) to call endpoints directly. ORPC context receives validated session for protected procedures.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Story 1.3 Authentication</section>
        <snippet>User sign-up with email/password validation (min 8 chars). User login with credential validation and session creation. Session persistence across browser refresh. Protected routes redirect unauthenticated users to /login. Forms follow UX design with inline validation and error states.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Dependencies</section>
        <snippet>Better-Auth 1.3.28 for authentication. ORPC 1.10.0 for type-safe API. Drizzle ORM 0.44.2 for database queries. PostgreSQL 16+ for data storage. TanStack React Form for form management.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/1-2-database-setup-and-schema-foundation.md</path>
        <title>Story 1.2 Completion Notes</title>
        <section>Better-Auth Configuration</section>
        <snippet>Better-Auth 1.3.28 configured in packages/auth/src/index.ts. User and session tables ready with proper indexes. Password hashing uses scrypt (161-char hashes). Test users available: test@example.com / TestPassword123!, admin@example.com / AdminPassword123!, demo@example.com / DemoPassword123!</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>packages/auth/src/index.ts</path>
        <kind>config</kind>
        <symbol>auth</symbol>
        <lines>1-19</lines>
        <reason>Better-Auth configuration with Drizzle adapter, email/password plugin, and nextCookies plugin for session management</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/lib/auth-client.ts</path>
        <kind>client</kind>
        <symbol>authClient</symbol>
        <lines>1-7</lines>
        <reason>Better-Auth React client for frontend authentication operations (signIn, signUp, signOut)</reason>
      </artifact>
      <artifact>
        <path>packages/api/src/context.ts</path>
        <kind>middleware</kind>
        <symbol>createContext</symbol>
        <lines>1-13</lines>
        <reason>ORPC context creation that extracts session from Better-Auth for authorization in protected procedures</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components/sign-in-form.tsx</path>
        <kind>component</kind>
        <symbol>SignInForm</symbol>
        <lines>1-135</lines>
        <reason>Login form component with email/password validation, error handling, and redirect logic</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components/sign-up-form.tsx</path>
        <kind>component</kind>
        <symbol>SignUpForm</symbol>
        <lines>1-160</lines>
        <reason>Registration form component with email/name/password validation, auto-login after signup</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/login/page.tsx</path>
        <kind>page</kind>
        <symbol>LoginPage</symbol>
        <lines>1-50</lines>
        <reason>Login page with toggle between sign-in and sign-up forms</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/dashboard/page.tsx</path>
        <kind>page</kind>
        <symbol>DashboardPage</symbol>
        <lines>1-22</lines>
        <reason>Protected dashboard page that requires authentication - tests route protection</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components/user-menu.tsx</path>
        <kind>component</kind>
        <symbol>UserMenu</symbol>
        <lines>1-60</lines>
        <reason>User menu dropdown with logout functionality and session display</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/api/auth/[...all]/route.ts</path>
        <kind>api-route</kind>
        <symbol>handler</symbol>
        <lines>1-4</lines>
        <reason>Catch-all route that mounts Better-Auth endpoints (/api/auth/sign-in, /api/auth/sign-up, etc.)</reason>
      </artifact>
      <artifact>
        <path>packages/db/src/schema/auth.ts</path>
        <kind>schema</kind>
        <symbol>users, sessions, accounts</symbol>
        <lines>1-50</lines>
        <reason>Database schema for Better-Auth tables (users, sessions, accounts) - DO NOT MODIFY, managed by Better-Auth</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>better-auth</package>
        <version>1.3.28</version>
        <purpose>Authentication framework with session management, password hashing, and CSRF protection</purpose>
      </node>
      <node>
        <package>@orpc/server</package>
        <version>1.10.0</version>
        <purpose>Type-safe RPC framework for API procedures</purpose>
      </node>
      <node>
        <package>@orpc/client</package>
        <version>1.10.0</version>
        <purpose>Type-safe RPC client for frontend</purpose>
      </node>
      <node>
        <package>drizzle-orm</package>
        <version>0.44.2</version>
        <purpose>Type-safe ORM for PostgreSQL queries</purpose>
      </node>
      <node>
        <package>pg</package>
        <version>8.14.1</version>
        <purpose>PostgreSQL client library</purpose>
      </node>
      <node>
        <package>@tanstack/react-form</package>
        <version>1.12.3</version>
        <purpose>Form state management with validation</purpose>
      </node>
      <node>
        <package>zod</package>
        <version>4.1.12</version>
        <purpose>Schema validation for form inputs</purpose>
      </node>
      <node>
        <package>sonner</package>
        <version>2.0.5</version>
        <purpose>Toast notifications for success/error messages</purpose>
      </node>
      <node>
        <package>next</package>
        <version>16.0.0</version>
        <purpose>React framework with App Router and API routes</purpose>
      </node>
      <node>
        <package>react</package>
        <version>19.2.0</version>
        <purpose>UI library</purpose>
      </node>
      <tools>
        <tool>bun</tool>
        <version>1.3.1</version>
        <purpose>JavaScript runtime and package manager</purpose>
      </tools>
      <tools>
        <tool>turbo</tool>
        <version>2.5.4</version>
        <purpose>Monorepo build system</purpose>
      </tools>
      <tools>
        <tool>@biomejs/biome</tool>
        <version>2.3.4</version>
        <purpose>Linter and formatter via Ultracite preset</purpose>
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>Architecture Pattern</type>
      <description>Better-Auth provides built-in route handlers at /api/auth/* endpoints. DO NOT create ORPC auth router - Better-Auth handles authentication endpoints natively. ORPC context receives session from Better-Auth middleware for protected procedures.</description>
      <source>docs/architecture.md - Authentication Flow</source>
    </constraint>
    <constraint>
      <type>Schema Management</type>
      <description>DO NOT modify auth schema tables (users, sessions, accounts) directly. These are managed by Better-Auth. Use Better Auth API (auth.api.signUpEmail()) for user creation to ensure proper password hashing and account records.</description>
      <source>.bmad-ephemeral/stories/1-2-database-setup-and-schema-foundation.md - Better-Auth Configuration</source>
    </constraint>
    <constraint>
      <type>Session Security</type>
      <description>Session cookies MUST have httpOnly (XSS protection), sameSite=lax (CSRF protection), and secure (HTTPS in production) flags. Session expiration: 7 days default. Never log passwords or session tokens.</description>
      <source>docs/architecture.md - Security Architecture</source>
    </constraint>
    <constraint>
      <type>Password Security</type>
      <description>Password validation: Minimum 8 characters enforced in form validation. Password hashing: scrypt algorithm (Better-Auth default) with 161-character hash output. Passwords stored in accounts table, not users table.</description>
      <source>.bmad-ephemeral/stories/tech-spec-epic-1.md - AC3</source>
    </constraint>
    <constraint>
      <type>Code Quality</type>
      <description>All code must pass `bun run check` with 0 errors. Follow Ultracite/Biome code standards from .claude/CLAUDE.md. TypeScript strict mode enforced across all packages. Use explicit types for clarity.</description>
      <source>docs/architecture.md - Code Quality Standards</source>
    </constraint>
    <constraint>
      <type>Form Validation UX</type>
      <description>Forms must follow UX design: inline validation with errors on blur, error messages in red (var(--color-error)), submit button disabled when form invalid, clear and actionable error messages.</description>
      <source>.bmad-ephemeral/stories/tech-spec-epic-1.md - AC3</source>
    </constraint>
    <constraint>
      <type>Testing Strategy</type>
      <description>Story 1.6 will establish comprehensive testing infrastructure (Bun test runner, Playwright E2E). For Story 1.3, validation is manual via browser testing with test users from seed data.</description>
      <source>.bmad-ephemeral/stories/1-3-authentication-system-integration.md - Dev Notes</source>
    </constraint>
    <constraint>
      <type>Accessibility</type>
      <description>Keyboard navigation for all form fields and buttons. ARIA labels on form inputs (implemented with shadcn/ui). Error messages announced to screen readers. Focus management after form submission.</description>
      <source>docs/architecture.md - Code Quality Standards</source>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Better-Auth Sign Up Endpoint</name>
      <kind>HTTP POST</kind>
      <signature>POST /api/auth/sign-up { email: string, password: string, name?: string } → { user, session }</signature>
      <path>apps/web/src/app/api/auth/[...all]/route.ts (mounted via Better-Auth handler)</path>
    </interface>
    <interface>
      <name>Better-Auth Sign In Endpoint</name>
      <kind>HTTP POST</kind>
      <signature>POST /api/auth/sign-in { email: string, password: string } → { user, session }</signature>
      <path>apps/web/src/app/api/auth/[...all]/route.ts (mounted via Better-Auth handler)</path>
    </interface>
    <interface>
      <name>Better-Auth Sign Out Endpoint</name>
      <kind>HTTP POST</kind>
      <signature>POST /api/auth/sign-out {} (session from cookie) → { success: boolean }</signature>
      <path>apps/web/src/app/api/auth/[...all]/route.ts (mounted via Better-Auth handler)</path>
    </interface>
    <interface>
      <name>Better-Auth Get Session</name>
      <kind>API Method</kind>
      <signature>auth.api.getSession({ headers }) → { user, session } | null</signature>
      <path>packages/auth/src/index.ts (exported auth object)</path>
    </interface>
    <interface>
      <name>Auth Client Sign In</name>
      <kind>React Hook</kind>
      <signature>authClient.signIn.email({ email, password }, { onSuccess, onError })</signature>
      <path>apps/web/src/lib/auth-client.ts (authClient export)</path>
    </interface>
    <interface>
      <name>Auth Client Sign Up</name>
      <kind>React Hook</kind>
      <signature>authClient.signUp.email({ email, password, name }, { onSuccess, onError })</signature>
      <path>apps/web/src/lib/auth-client.ts (authClient export)</path>
    </interface>
    <interface>
      <name>Auth Client Sign Out</name>
      <kind>React Hook</kind>
      <signature>authClient.signOut({ onSuccess })</signature>
      <path>apps/web/src/lib/auth-client.ts (authClient export)</path>
    </interface>
    <interface>
      <name>ORPC Context</name>
      <kind>Type Definition</kind>
      <signature>type Context = { session?: { user: { id, email, name, image }, session: { id, expiresAt } } }</signature>
      <path>packages/api/src/context.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Testing infrastructure will be established in Story 1.6 (Epic 1). Until then, Story 1.3 uses manual browser testing with seed data test users. Standards from tech-spec:

**Unit Tests (Bun test runner):**
- Coverage target: 70%+ line coverage for critical paths
- Test files colocated with source: *.test.ts, *.test.tsx
- Frameworks: Bun built-in test runner, React Testing Library for components

**E2E Tests (Playwright):**
- Located in dedicated apps/e2e/ application
- Run via `bun test:e2e`
- Test critical user journeys (signup, login, logout, protected routes)

**Code Quality:**
- All code must pass `bun run check` (Ultracite/Biome linting)
- TypeScript strict mode enforced
- No console.log, debugger, or alert statements in production code
    </standards>
    <locations>
      <location>*.test.ts (unit tests colocated with source)</location>
      <location>*.test.tsx (component tests colocated with source)</location>
      <location>apps/e2e/ (Playwright E2E tests - Story 1.6)</location>
    </locations>
    <ideas>
      <idea ac="AC1">
        <title>Sign-up flow creates user and auto-logs in</title>
        <approach>Manual: Navigate to /login, switch to sign-up, enter unique email/name/password (8+ chars), submit. Verify redirect to /dashboard, success toast, and database user/account/session records created.</approach>
      </idea>
      <idea ac="AC2">
        <title>Login with valid credentials succeeds</title>
        <approach>Manual: Use test@example.com / TestPassword123! from seed data. Navigate to /login, enter credentials, submit. Verify redirect to /dashboard, user name displayed in UI, and session created in database.</approach>
      </idea>
      <idea ac="AC3">
        <title>Invalid credentials show error message</title>
        <approach>Manual: Attempt login with wrong password or non-existent email. Verify error toast with clear message, no redirect (stay on /login), and no session created in database.</approach>
      </idea>
      <idea ac="AC4">
        <title>Session persists across browser refresh</title>
        <approach>Manual: Log in, verify on /dashboard, refresh browser (F5). Verify still logged in on /dashboard with user data displayed and session cookie still present in DevTools.</approach>
      </idea>
      <idea ac="AC5">
        <title>Session cookies have security flags</title>
        <approach>Manual: Log in, open DevTools → Application → Cookies. Locate Better-Auth session cookie. Verify httpOnly=true, sameSite=Lax, and reasonable expiration (7 days). Note: secure flag only in production (HTTPS).</approach>
      </idea>
      <idea ac="AC6">
        <title>Logout clears session and redirects</title>
        <approach>Manual: Log in, navigate to /dashboard, click user menu, click "Sign Out". Verify redirect to /, session deleted/invalidated in database, session cookie removed from browser, and /dashboard access redirects to /login.</approach>
      </idea>
      <idea ac="AC7">
        <title>Protected routes redirect unauthenticated users</title>
        <approach>Manual: Clear cookies (ensure logged out), directly navigate to /dashboard. Verify automatic redirect to /login. Then log in and verify redirect back to /dashboard works.</approach>
      </idea>
      <idea ac="AC8">
        <title>Form validation provides inline feedback</title>
        <approach>Manual: Test email validation (invalid format), password validation (&lt;8 chars), name validation (&lt;2 chars on sign-up). Verify errors display in red, submit button disabled when invalid, errors appear on blur, and errors clear when field becomes valid.</approach>
      </idea>
      <idea ac="All">
        <title>Edge cases and polish</title>
        <approach>Manual: Test rapid form submissions (should prevent double-submit), network error handling (disconnect during submit), loading states during auth, email case sensitivity (should be case-insensitive), password obscured in field, and cross-browser compatibility (Chrome, Firefox, Safari).</approach>
      </idea>
    </ideas>
  </tests>
</story-context>
