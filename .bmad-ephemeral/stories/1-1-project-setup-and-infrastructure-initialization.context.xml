<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.1</storyId>
    <title>Project Setup and Infrastructure Initialization</title>
    <status>drafted</status>
    <generatedAt>2025-11-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/1-1-project-setup-and-infrastructure-initialization.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>a properly configured monorepo with Next.js, TypeScript, and core dependencies</iWant>
    <soThat>the team has a solid foundation to build features on</soThat>
    <tasks>
      <task id="1" ac="2">Verify monorepo structure</task>
      <task id="2" ac="2">Configure TypeScript strict mode</task>
      <task id="3" ac="2">Integrate Ultracite linting</task>
      <task id="4" ac="3">Verify Turborepo build orchestration</task>
      <task id="5" ac="1,4">Verify Next.js development server</task>
      <task id="6" ac="1">Document setup process</task>
      <task id="7" ac="1,2,3,4">Testing and validation</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">
      <summary>Development environment starts successfully</summary>
      <details>Given a cloned repository, when I run `bun install` and `bun run dev`, then the development server starts without errors and all dependencies are installed successfully</details>
    </criterion>
    <criterion id="2">
      <summary>Monorepo structure is complete</summary>
      <details>/apps/web (Next.js 16 + React 19), /packages/api (ORPC), /packages/db (Drizzle ORM), /packages/auth (Better-Auth), TypeScript configured across all packages with strict mode</details>
    </criterion>
    <criterion id="3">
      <summary>Build system compiles without errors</summary>
      <details>When I run `bun run build`, then all packages compile successfully and the production build is generated</details>
    </criterion>
    <criterion id="4">
      <summary>Hot module replacement works</summary>
      <details>Given the development server is running, when I modify a source file, then changes are reflected in the browser &lt; 1s and application state is preserved where possible</details>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-1-foundation-project-infrastructure.md</path>
        <title>Epic 1: Foundation &amp; Project Infrastructure</title>
        <section>Story 1.1: Project Setup and Infrastructure Initialization</section>
        <snippet>Establish core technical foundation with Next.js 16, React 19, TypeScript 5 in strict mode. Monorepo structure using Turborepo 2.5.4 and Bun 1.3.1 with four packages: web (Next.js), api (ORPC), db (Drizzle), auth (Better-Auth).</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation &amp; Project Infrastructure</title>
        <section>Detailed Design &gt; Services and Modules</section>
        <snippet>Monorepo architecture with Next.js 16 frontend, ORPC 1.10 type-safe API layer, Better-Auth 1.3.28 session management, Drizzle ORM 0.44.2 database layer. Ultracite 6.3.2 + Biome 2.3.4 for code quality enforcement.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Project Infrastructure &amp; Setup</section>
        <snippet>Brownfield monorepo with Turborepo. Development stack: Next.js 16 App Router, React 19, TypeScript 5 strict mode, TailwindCSS, shadcn/ui components. Code quality via Biome/Ultracite zero-config preset. Workspace dependencies via `workspace:*` protocol.</snippet>
      </doc>
      <doc>
        <path>.claude/CLAUDE.md</path>
        <title>Ultracite Code Standards</title>
        <section>Core Principles</section>
        <snippet>Write accessible, performant, type-safe, maintainable code. Use explicit types, modern JS/TS patterns, async/await syntax. Biome enforces strict linting automatically via Ultracite preset. Focus on clarity over brevity.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>package.json</path>
        <kind>config</kind>
        <symbol>workspaces</symbol>
        <lines>6-9</lines>
        <reason>Root workspace configuration defining monorepo structure with apps/* and packages/* workspaces. PackageManager field specifies exact Bun 1.3.1 version.</reason>
      </artifact>
      <artifact>
        <path>turbo.json</path>
        <kind>config</kind>
        <symbol>pipeline</symbol>
        <lines>all</lines>
        <reason>Turborepo task orchestration defining build, dev, lint, check-types, and database task dependencies. Configures caching and persistent tasks.</reason>
      </artifact>
      <artifact>
        <path>tsconfig.base.json</path>
        <kind>config</kind>
        <symbol>compilerOptions</symbol>
        <lines>all</lines>
        <reason>Shared TypeScript configuration with strict mode enabled globally. Sets module resolution, target ESNext, and enforces type safety with strictNullChecks, noUnusedLocals, etc.</reason>
      </artifact>
      <artifact>
        <path>biome.json</path>
        <kind>config</kind>
        <symbol>extends</symbol>
        <lines>all</lines>
        <reason>Biome linting configuration extending ultracite/core and ultracite/next presets. Defines file ignores (.next/, dist/, .turbo/) and includes.</reason>
      </artifact>
      <artifact>
        <path>apps/web/package.json</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>all</lines>
        <reason>Web app dependencies: Next.js 16, React 19, ORPC, TanStack Query, Better-Auth client, shadcn/ui components, TailwindCSS 4. References workspace packages @planner/api and @planner/auth.</reason>
      </artifact>
      <artifact>
        <path>apps/web/next.config.ts</path>
        <kind>config</kind>
        <symbol>nextConfig</symbol>
        <lines>all</lines>
        <reason>Next.js configuration with typedRoutes enabled for type-safe navigation and reactCompiler for React 19 compiler optimizations.</reason>
      </artifact>
      <artifact>
        <path>apps/web/tsconfig.json</path>
        <kind>config</kind>
        <symbol>paths</symbol>
        <lines>all</lines>
        <reason>Next.js TypeScript config with path alias @/* â†’ ./src/* for clean imports. Target ES2017, JSX preserve, strict mode enabled.</reason>
      </artifact>
      <artifact>
        <path>packages/db/package.json</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>all</lines>
        <reason>Database package with Drizzle ORM 0.44.2, pg 8.14.1 PostgreSQL client, Drizzle Kit 0.31.2 for migrations. Scripts for db:push, db:migrate, db:studio, Docker Compose commands.</reason>
      </artifact>
      <artifact>
        <path>packages/db/drizzle.config.ts</path>
        <kind>config</kind>
        <symbol>default export</symbol>
        <lines>all</lines>
        <reason>Drizzle ORM configuration specifying schema location (./src/schema), migration output (./src/migrations), dialect (postgresql), and database connection from DATABASE_URL env var.</reason>
      </artifact>
      <artifact>
        <path>packages/db/src/index.ts</path>
        <kind>module</kind>
        <symbol>db</symbol>
        <lines>all</lines>
        <reason>Exports Drizzle ORM instance initialized with PostgreSQL connection. Central database abstraction layer used by all packages.</reason>
      </artifact>
      <artifact>
        <path>packages/db/src/schema/auth.ts</path>
        <kind>schema</kind>
        <symbol>users, sessions, accounts, verification</symbol>
        <lines>all</lines>
        <reason>Authentication database schema tables for Better-Auth. Defines user, session, account (OAuth), and verification tables with proper indexes and foreign keys.</reason>
      </artifact>
      <artifact>
        <path>packages/api/package.json</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>all</lines>
        <reason>API package with ORPC 1.10 framework, references workspace packages @planner/auth and @planner/db. Uses tsdown for build.</reason>
      </artifact>
      <artifact>
        <path>packages/api/src/context.ts</path>
        <kind>module</kind>
        <symbol>createContext, Context</symbol>
        <lines>all</lines>
        <reason>ORPC context creation extracting session from Better-Auth on each request. Exports Context type for procedure type safety.</reason>
      </artifact>
      <artifact>
        <path>packages/api/src/index.ts</path>
        <kind>module</kind>
        <symbol>publicProcedure, protectedProcedure</symbol>
        <lines>all</lines>
        <reason>Defines ORPC procedures with authentication middleware. Public procedures accessible without auth, protected procedures require valid session. Uses middleware pattern for authorization.</reason>
      </artifact>
      <artifact>
        <path>packages/api/src/routers/index.ts</path>
        <kind>router</kind>
        <symbol>appRouter</symbol>
        <lines>all</lines>
        <reason>Main ORPC router with example healthCheck and privateData endpoints. Demonstrates public vs protected procedure usage. Type-exported as AppRouter for client-side type safety.</reason>
      </artifact>
      <artifact>
        <path>packages/auth/package.json</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>all</lines>
        <reason>Auth package with Better-Auth 1.3.28, references @planner/db for database integration. Uses tsdown for build.</reason>
      </artifact>
      <artifact>
        <path>packages/auth/src/index.ts</path>
        <kind>module</kind>
        <symbol>auth</symbol>
        <lines>all</lines>
        <reason>Better-Auth configuration with Drizzle adapter, email/password authentication enabled, Next.js cookies plugin for session management. Integrates with @planner/db schema.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/api/rpc/[[...rest]]/route.ts</path>
        <kind>api-route</kind>
        <symbol>handleRequest</symbol>
        <lines>all</lines>
        <reason>Next.js API route handler for ORPC. Catch-all route at /api/rpc/[[...rest]] handling GET, POST, PUT, PATCH, DELETE. Creates context with session, tries RPC handler then OpenAPI handler, returns 404 if no match.</reason>
      </artifact>
      <artifact>
        <path>packages/db/tsdown.config.ts</path>
        <kind>config</kind>
        <symbol>default export</symbol>
        <lines>all</lines>
        <reason>Tsdown build configuration for packages: entry src/**/*.ts, sourcemap enabled, dts (type declarations) enabled. Used by all internal packages for TypeScript compilation.</reason>
      </artifact>
      <artifact>
        <path>bunfig.toml</path>
        <kind>config</kind>
        <symbol>install.linker</symbol>
        <lines>all</lines>
        <reason>Bun configuration with isolated linker mode for package installation.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="bun-workspace">
        <package name="bun" version="1.3.1" />
        <package name="turbo" version="^2.5.4" />
        <package name="@biomejs/biome" version="2.3.4" />
        <package name="ultracite" version="6.3.2" />
        <package name="typescript" version="^5" />
      </ecosystem>
      <ecosystem name="frontend">
        <package name="next" version="16.0.0" />
        <package name="react" version="19.2.0" />
        <package name="react-dom" version="19.2.0" />
        <package name="tailwindcss" version="^4.1.10" />
        <package name="radix-ui" version="^1.4.2" />
        <package name="lucide-react" version="^0.546.0" />
        <package name="sonner" version="^2.0.5" />
        <package name="next-themes" version="^0.4.6" />
      </ecosystem>
      <ecosystem name="api">
        <package name="@orpc/server" version="^1.10.0" />
        <package name="@orpc/client" version="^1.10.0" />
        <package name="@orpc/zod" version="^1.10.0" />
        <package name="@orpc/openapi" version="^1.10.0" />
        <package name="@orpc/tanstack-query" version="^1.10.0" />
        <package name="@tanstack/react-query" version="^5.85.5" />
      </ecosystem>
      <ecosystem name="database">
        <package name="drizzle-orm" version="^0.44.2" />
        <package name="drizzle-kit" version="^0.31.2" />
        <package name="pg" version="^8.14.1" />
        <package name="@types/pg" version="^8.11.11" />
      </ecosystem>
      <ecosystem name="authentication">
        <package name="better-auth" version="^1.3.28" />
      </ecosystem>
      <ecosystem name="validation">
        <package name="zod" version="^4.1.12" />
      </ecosystem>
      <ecosystem name="build-tools">
        <package name="tsdown" version="^0.15.5" />
        <package name="dotenv" version="^17.2.2" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Monorepo managed by Turborepo with Bun workspaces. Internal packages use workspace:* protocol. All packages must build successfully via turbo build.</constraint>
    <constraint type="typescript">Strict mode enabled globally via tsconfig.base.json. All packages extend base config. Path aliases configured: @/* for web app, @planner/* for workspace packages.</constraint>
    <constraint type="code-quality">Ultracite preset enforces strict Biome linting rules. Code must pass `bun run check` before commit. TypeScript must pass `bun run check-types`.</constraint>
    <constraint type="versioning">Exact Bun version 1.3.1 via packageManager field. Shared versions via catalog in root package.json (Next.js 16, ORPC 1.10, Better-Auth 1.3.28, Drizzle 0.44.2).</constraint>
    <constraint type="build">Each internal package uses tsdown for compilation with sourcemaps and type declarations. Output to dist/ folder. Composite TypeScript projects for incremental builds.</constraint>
    <constraint type="development">Development server runs on port 3001 (apps/web). Hot module replacement via Next.js Fast Refresh. Database via Docker Compose (PostgreSQL 16).</constraint>
    <constraint type="testing">Story 1.1 focuses on infrastructure validation, not testing infrastructure setup (covered in Story 1.6). Verification via running dev/build commands.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Workspace Package Exports</name>
      <kind>module-exports</kind>
      <signature>
        exports: {
          ".": { types: "./dist/index.d.ts", default: "./src/index.ts" },
          "./*": { types: "./dist/*.d.ts", default: "./src/*.ts" }
        }
      </signature>
      <path>packages/*/package.json</path>
    </interface>
    <interface>
      <name>ORPC Context</name>
      <kind>type-definition</kind>
      <signature>
        export type Context = {
          user?: { id: string; email: string; name?: string; image?: string; };
          session?: { id: string; expiresAt: Date; };
        };
      </signature>
      <path>packages/api/src/context.ts</path>
    </interface>
    <interface>
      <name>App Router Type Export</name>
      <kind>type-definition</kind>
      <signature>
        export type AppRouter = typeof appRouter;
        export type AppRouterClient = RouterClient&lt;typeof appRouter&gt;;
      </signature>
      <path>packages/api/src/routers/index.ts</path>
    </interface>
    <interface>
      <name>Database Instance</name>
      <kind>database-client</kind>
      <signature>export const db: PostgresJsDatabase&lt;typeof schema&gt; = drizzle(client, { schema });</signature>
      <path>packages/db/src/index.ts</path>
    </interface>
    <interface>
      <name>Better-Auth Instance</name>
      <kind>auth-client</kind>
      <signature>export const auth = betterAuth&lt;BetterAuthOptions&gt;({ database, trustedOrigins, emailAndPassword, plugins });</signature>
      <path>packages/auth/src/index.ts</path>
    </interface>
    <interface>
      <name>Turborepo Scripts</name>
      <kind>npm-scripts</kind>
      <signature>
        dev: "turbo dev"
        build: "turbo build"
        check-types: "turbo check-types"
        check: "biome check --write ."
      </signature>
      <path>package.json</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Story 1.1 focuses on infrastructure verification, not test implementation. Validation approach: 1) Run `bun install` in clean directory, 2) Run `bun run dev` and verify server starts on port 3001, 3) Run `bun run build` and verify all packages compile, 4) Run `bun run check-types` and verify TypeScript passes, 5) Run `bun run check` and verify Biome linting passes, 6) Test HMR by editing a component and observing browser update &lt; 1s. Testing infrastructure (Bun test runner, Playwright E2E) will be set up in Story 1.6.</standards>
    <locations>
      <location>Testing infrastructure to be created in Story 1.6</location>
      <location>apps/e2e/ - E2E tests (future)</location>
      <location>**/*.test.ts - Unit tests colocated with source (future)</location>
    </locations>
    <ideas>
      <idea ac="1">Manual verification: Clone repo, run `bun install`, verify no errors. Run `bun run dev`, verify server starts and logs "Ready on http://localhost:3001".</idea>
      <idea ac="2">Manual verification: Check directory structure exists with `ls -la apps/ packages/`. Verify package.json workspaces field lists apps/* and packages/*. Run `bun run check-types` and verify TypeScript compiles with strict mode.</idea>
      <idea ac="3">Manual verification: Run `bun run build` and verify turbo builds all packages. Check dist/ folders created in each package. Verify build logs show no errors.</idea>
      <idea ac="4">Manual verification: Start dev server, edit apps/web/src/app/page.tsx, save, observe browser auto-updates within 1 second without full page reload.</idea>
    </ideas>
  </tests>
</story-context>
